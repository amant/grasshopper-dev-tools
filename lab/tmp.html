<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hello world</title>
</head>

<body>
    <div id="app">
        <at-tree data='[{"nodeName":"ING-ORANGE-BUSINESS-INSIGHTS-STANDALONE-DEMO","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[]},{"nodeName":"ING-UTIL-WEBTREKK","isHTMLElement":true,"children":[]},{"nodeName":"ING-KIT-DEMO-PAGE","isHTMLElement":true,"children":[{"nodeName":"APP-LOCATION","isHTMLElement":true,"children":[{"nodeName":"IRON-QUERY-PARAMS","isHTMLElement":true,"children":[]},{"nodeName":"IRON-LOCATION","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"SELECT","isHTMLElement":true,"children":[{"nodeName":"DOM-REPEAT","isHTMLElement":true,"children":[]}]}]},{"nodeName":"PAPER-TABS","isHTMLElement":true,"children":[{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[]}]},{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]}]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"MAIN","isHTMLElement":true,"children":[]}]}]}]},{"nodeName":"ING-ORANGE-BUSINESS-EXPERIMENT-SURVEY-DEMO","isHTMLElement":true,"children":[{"nodeName":"ING-KIT-DEMO-PAGE","isHTMLElement":true,"children":[{"nodeName":"APP-LOCATION","isHTMLElement":true,"children":[{"nodeName":"IRON-QUERY-PARAMS","isHTMLElement":true,"children":[]},{"nodeName":"IRON-LOCATION","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"SELECT","isHTMLElement":true,"children":[{"nodeName":"DOM-REPEAT","isHTMLElement":true,"children":[]}]}]},{"nodeName":"PAPER-TABS","isHTMLElement":true,"children":[{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[]}]},{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]}]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"MAIN","isHTMLElement":true,"children":[]}]}]}]},{"nodeName":"ING-ORANGE-BUSINESS-INSIGHTS-FEEDBACK-DEMO","isHTMLElement":true,"children":[{"nodeName":"ING-KIT-DEMO-PAGE","isHTMLElement":true,"children":[{"nodeName":"APP-LOCATION","isHTMLElement":true,"children":[{"nodeName":"IRON-QUERY-PARAMS","isHTMLElement":true,"children":[]},{"nodeName":"IRON-LOCATION","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"SELECT","isHTMLElement":true,"children":[{"nodeName":"DOM-REPEAT","isHTMLElement":true,"children":[]}]}]},{"nodeName":"PAPER-TABS","isHTMLElement":true,"children":[{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"DIV","isHTMLElement":true,"children":[]}]},{"nodeName":"PAPER-ICON-BUTTON","isHTMLElement":true,"children":[{"nodeName":"IRON-ICON","isHTMLElement":true,"children":[]}]}]}]},{"nodeName":"DIV","isHTMLElement":true,"children":[{"nodeName":"MAIN","isHTMLElement":true,"children":[]}]}]}]}]'></at-tree>
    </div>

    <script type="module">
        import { LitElement, html, css } from 'https://unpkg.com/lit-element?module';

        class AtTree extends LitElement {
            static get styles() {
                return css`
                    /* Remove default bullets */
                    ul, #myUL {
                        list-style-type: none;
                    }

                    /* Remove margins and padding from the parent ul */
                    #myUL {
                        margin: 0;
                        padding: 0;
                    }

                    /* Style the caret/arrow */
                    .caret {
                        cursor: pointer;
                        user-select: none; /* Prevent text selection */
                    }

                    /* Create the caret/arrow with a unicode, and style it */
                    .caret::before {
                        content: "\\25B6";
                        color: black;
                        display: inline-block;
                        margin-right: 6px;
                    }

                    /* Rotate the caret/arrow icon when clicked on (using JavaScript) */
                    .caret-down::before {
                        transform: rotate(90deg);
                    }

                    /* Hide the nested list */
                    .nested {
                        display: none;
                    }

                    /* Show the nested list when the user clicks on the caret/arrow (with JavaScript) */
                    .active {
                        display: block;
                    }
                `;
            }

            static get properties() {
                return {
                    data: { type: String }
                };
            }

            _isCustomElement(elementName) {
                return elementName.includes('-');
            }

            _getElementCollection(value) {
                try {
                    const elementCollection = JSON.parse(value);
                    return elementCollection;
                } catch (err) {
                    console.error(err);
                    return [];
                }
            }

            _toggleExpand(event) {
                const el = event.target;
                el.parentElement.querySelector('.nested').classList.toggle('active');
                el.classList.toggle('caret-down');
            }

            get _componentStructureTemplate() {
                const getNameWithToggleExpand = name => html`<span class="caret" @click="${this._toggleExpand}">${name}</span>`;

                const getName = name => html`<span>${name}</span>`;

                const isWebComponent = (name) => name.includes('-');

                const getNodeNameAndLastElement = el => {                    
                    const hasOneChild = el.children && el.children.length === 1;
                    let nodeName = `<${el.nodeName.toLowerCase()}>`;
                    let element = el;

                    if (hasOneChild && !isWebComponent(el.children[0].nodeName)) {
                        let [name, newElement] = getNodeNameAndLastElement(el.children[0]);
                        nodeName += ` / ${name.toLowerCase()}`;
                        element = newElement;
                    }

                    return [nodeName, element];
                }

                const walk = elements => elements.map(el => {
                    const [nodeName, element] = getNodeNameAndLastElement(el);                    
                    const hasChildren = element.children && element.children.length > 0;

                    if (!nodeName.includes('-') && !hasChildren) {
                        return html``;
                    }

                    return html`<li>
                        ${ hasChildren ? getNameWithToggleExpand(nodeName) : getName(nodeName) }
                        ${ hasChildren ? html`<ul class="nested">${walk(element.children)}</ul>` : '' }
                    </li>`;
                });

                const collection = this._getElementCollection(this.data);
                console.log('my collection', collection);

                return html`<ul id="myUL">${walk(collection)}</ul>`;
            }

            render() {
                return html`${this._componentStructureTemplate}`;
            }
        }
        customElements.define('at-tree', AtTree)
    </script>
</body>

</html>